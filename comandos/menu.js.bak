const axios = require('axios');
const { performance } = require('perf_hooks');
const info = require('../dono/info.json');

async function getBuffer(url) {
  try {
    const res = await axios.get(url, { responseType: 'arraybuffer' });
    return res.data;
  } catch (e) {
    console.error('Erro ao baixar thumbnail do menu:', e);
    return null;
  }
}

module.exports = async function menuCommand(msg, sock, from) {
  try {
    const sender = msg.key.participant || msg.participant || msg.key.remoteJid || from;
    const userTag = `@${sender.split('@')[0]}`;
    const isDono = sender.includes(info.numerodono);

    const groupMetadata = await sock.groupMetadata(from);
    const isAdmin = groupMetadata.participants?.some(p => p.id === sender && (p.admin === 'admin' || p.admin === 'superadmin'));
    const admStatus = isAdmin ? 'âœ…' : 'âŒ';

    const start = performance.now();
    await sock.sendMessage(from, { react: { text: 'ğŸ™‡ğŸ»â€â™€ï¸', key: msg.key } });

    const thumbnail = await getBuffer('https://i.postimg.cc/Gtr3K8bY/IMG-20250712-WA0027.jpg');
    const end = performance.now();
    const ping = Math.floor(end - start);

    const hora = new Date().toLocaleTimeString('pt-BR', { timeZone: 'America/Sao_Paulo' });
    const uptime = process.uptime();
    const uptimeHoras = Math.floor(uptime / 3600);
    const uptimeMin = Math.floor((uptime % 3600) / 60);
    const uptimeSeg = Math.floor(uptime % 60);

    const menuText = `â•­â”€ââââğŸ©¸âââââ”€â•®
â”‚âœ­ ğ—¢ğ—¶ğ—¶ ${userTag}
â”‚âœ­ ğ—¼ğ—»ğ—¹ğ—¶ğ—»ğ—² ğ—®: ${uptimeHoras}ğ—µ ${uptimeMin}ğ—º ${uptimeSeg}ğ˜€
â”‚âœ­ ğ—›ğ—¼ğ—¿ğ—®: ${hora}
â”‚âœ­ ğ——ğ—¼ğ—»ğ—¼: ${isDono ? 'â˜‘ï¸' : 'âŒ'}
â”‚âœ­ ğ—”ğ—±ğ—º: ${admStatus}
â”‚âœ­ ğ—•ğ—¼ğ˜: ${info.nomebot}
â•°â”€ââââğŸ©¸âââââ”€â•¯

... (resto do texto do menu que vocÃª jÃ¡ tem) ...
â•°â”€â”€â”€â”€â”€â€¢ğ‘ºğ’‚ğ’ğ’Šğ’›ğ’Šğ’ğ’‰ğ’‚ğ‘©ğ’ğ’•â€¢â”€â”€â”€â”€â”€â•¯`;

    await sock.sendMessage(from, {
      text: menuText,
      mentions: [sender],
      contextInfo: {
        mentionedJid: [sender],
        externalAdReply: {
          title: 'ğŸª ğ— ğ—˜ğ—¡ğ—¨ ğ—œğ—¡ğ—œğ—–ğ—œğ—”ğ—Ÿ âœ¨',
          body: `âš¡ ğ˜—ğ˜ªğ˜¯ğ˜¨: ${ping}ms`,
          mediaType: 1,
          previewType: 0,
          renderLargerThumbnail: true,
          thumbnail,
          mediaUrl: 'https://linkfly.to/nexosfc',
          sourceUrl: 'https://nexosofc'
        }
      }
    }, { quoted: msg });

  } catch (err) {
    console.error('Erro ao enviar menu:', err);
    await sock.sendMessage(from, { text: 'âŒ Erro ao carregar menu.' }, { quoted: msg });
  }
};